<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="hsn_logo.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>HSN Dashboard</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />
    <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400&display=swap');
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen text-slate-800">

<div id="app" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-8">
    <header class="flex justify-between items-center bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
        <div class="flex items-center gap-3">
            <h1 class="text-xl font-bold tracking-tight">Hive Sensor <span class="text-indigo-600">Network</span></h1>
        </div>
        <nav class="flex gap-6 text-sm font-medium text-slate-600">
            <a href="#" class="hover:text-indigo-600 transition-colors">About</a>
            <a href="https://auth.eldonbaitandtackle.net/realms/hsn_kc/protocol/openid-connect/auth?client_id=public_client&response_type=code&redirect_uri=https://hsw.eldonbaitandtackle.net" class="hover:text-indigo-600 transition-colors">Manage</a>
            <button id="refresh-btn" class="text-indigo-600 hover:text-indigo-700">Refresh Data</button>
        </nav>
    </header>

    <main class="grid grid-cols-1 lg:grid-cols-3 gap-8 h-[600px]">
        <div class="lg:col-span-2 bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden relative">
            <div id="map" class="w-full h-full z-0"></div>
            <div id="loading" class="absolute inset-0 bg-white/80 z-50 flex items-center justify-center backdrop-blur-sm hidden">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div>
            </div>
            <div id="error" class="absolute top-4 left-4 right-4 bg-red-50 text-red-600 p-3 rounded-lg text-sm border border-red-100 hidden"></div>
        </div>

        <div class="flex flex-col gap-6">
            <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex-1 min-h-0">
                <h3 class="text-sm font-semibold text-slate-500 uppercase tracking-wider mb-4">Network Status</h3>
                <div class="h-48 relative">
                    <canvas id="doughnutChart"></canvas>
                </div>
            </div>
            <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex-1 min-h-0">
                <h3 class="text-sm font-semibold text-slate-500 uppercase tracking-wider mb-4">Temperature Variance</h3>
                <div class="h-48 relative">
                    <canvas id="barChart"></canvas>
                </div>
            </div>
        </div>
    </main>

    <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
        <div class="px-6 py-4 border-b border-slate-50 flex justify-between items-center bg-slate-50/50">
            <h3 class="font-semibold text-slate-800">Sensor Telemetry</h3>
            <span class="text-xs bg-emerald-100 text-emerald-700 px-2 py-1 rounded-full font-medium">Live</span>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full text-left">
                <thead>
                <tr class="text-xs font-semibold text-slate-400 uppercase border-b border-slate-100">
                    <th class="px-6 py-3">Location</th>
                    <th class="px-6 py-3">Temp (°F)</th>
                    <th class="px-6 py-3">Avg Neighbor</th>
                    <th class="px-6 py-3">Status</th>
                    <th class="px-6 py-3">Deviation</th>
                </tr>
                </thead>
                <tbody id="data-table-body" class="divide-y divide-slate-50 text-sm"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    const API_ENDPOINT = 'https://hsn.eldonbaitandtackle.net/api/';
    const map = new maplibregl.Map({
        container: 'map',
        style: {
            version: 8,
            sources: {
                'osm': {
                    type: 'raster',
                    tiles: ['https://tile.openstreetmap.org/{z}/{x}/{y}.png'],
                    tileSize: 256,
                    attribution: '&copy; OpenStreetMap Contributors',
                }
            },
            layers: [{ id: 'osm', type: 'raster', source: 'osm' }]
        },
        center: [0, 20],
        zoom: 2
    });

    map.addControl(new maplibregl.NavigationControl(), 'top-right');

    const markers = [];
    let barChartInstance = null;
    let doughnutChartInstance = null;

    function clampLat(lat) {
        return Math.max(-85, Math.min(85, lat));
    }

    function updateConnectionLines(mapData) {
        if (map.getLayer('connections-layer')) map.removeLayer('connections-layer');
        if (map.getSource('connections')) map.removeSource('connections');

        const features = [];
        const nodeMap = new Map(mapData.map(node => [String(node.id), node.location]));
        const processedPairs = new Set();

        mapData.forEach(node => {
            if (!node.neighbors) return;
            const startLoc = node.location;

            node.neighbors.forEach(neighborId => {
                const endLoc = nodeMap.get(String(neighborId));
                const pairId = [node.id, neighborId].sort().join('-');

                if (endLoc && !processedPairs.has(pairId)) {
                    processedPairs.add(pairId);
                    features.push({
                        type: 'Feature',
                        properties: {},
                        geometry: {
                            type: 'LineString',
                            coordinates: [
                                [startLoc[1], clampLat(startLoc[0])],
                                [endLoc[1], clampLat(endLoc[0])]
                            ]
                        }
                    });
                }
            });
        });

        map.addSource('connections', {
            type: 'geojson',
            data: { type: 'FeatureCollection', features }
        });

        map.addLayer({
            id: 'connections-layer',
            type: 'line',
            source: 'connections',
            layout: { 'line-join': 'round', 'line-cap': 'round' },
            paint: {
                'line-color': '#6366f1',
                'line-width': 2,
                'line-opacity': 0.6
            }
        });
    }

    function updateCharts(data) {
        const labels = data.map(d => `ID: ${d.module_id}`);
        const temps = data.map(d => d.self_temp);
        const deviations = data.map(d => d.deviation);
        const devCounts = [0, 0, 0];

        data.forEach(d => {
            if (d.deviation < 0.3) devCounts[0]++;
            else if (d.deviation < 0.7) devCounts[1]++;
            else devCounts[2]++;
        });

        const chartFont = { family: "'Inter', sans-serif", size: 11 };

        const barCtx = document.getElementById('barChart');
        if (barChartInstance) barChartInstance.destroy();
        if (barCtx) {
            barChartInstance = new Chart(barCtx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Temp', data: temps, backgroundColor: '#818cf8', borderRadius: 4 },
                        { label: 'Deviation', data: deviations, backgroundColor: '#94a3b8', borderRadius: 4 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { display: false, grid: { display: false } },
                        x: { display: false, grid: { display: false } }
                    }
                }
            });
        }

        const doughCtx = document.getElementById('doughnutChart');
        if (doughnutChartInstance) doughnutChartInstance.destroy();
        if (doughCtx) {
            doughnutChartInstance = new Chart(doughCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Good', 'Warning', 'Critical'],
                    datasets: [{
                        data: devCounts,
                        backgroundColor: ['#34d399', '#fbbf24', '#f87171'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'right', labels: { usePointStyle: true, font: chartFont, boxWidth: 8 } } },
                    cutout: '70%'
                }
            });
        }
    }

    async function apiCall(requestType, payload = {}) {
        const url = new URL(API_ENDPOINT);
        url.searchParams.append('request', requestType);
        for (const [key, value] of Object.entries(payload)) {
            url.searchParams.append(key, String(value));
        }
        const response = await fetch(url.toString());
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        return await response.json();
    }

    async function fetchAndDisplayData() {
        const loadingEl = document.getElementById('loading');
        const errorEl = document.getElementById('error');
        const tableBody = document.getElementById('data-table-body');

        if (loadingEl) loadingEl.classList.remove('hidden');
        if (errorEl) errorEl.classList.add('hidden');

        try {
            const [mapResponse, heuristicsResponse] = await Promise.all([
                apiCall('get_map'),
                apiCall('get_heuristics')
            ]);

            const mapData = mapResponse.results || [];
            const heuristicsData = heuristicsResponse.results || [];

            updateConnectionLines(mapData);

            const mergedData = heuristicsData.map(h => {
                const node = mapData.find(m => String(m.id) === String(h.module_id));
                const rawLat = node ? node.location[0] : 0;
                const rawLong = node ? node.location[1] : 0;
                return { ...h, lat: clampLat(rawLat), long: rawLong };
            });

            markers.forEach(marker => marker.remove());
            markers.length = 0;
            const bounds = new maplibregl.LngLatBounds();

            mergedData.forEach((sensor) => {
                const popup = new maplibregl.Popup({ offset: 25 }).setHTML(`
                    <div class="font-sans p-2">
                        <h3 class="font-bold text-indigo-600">Module ${sensor.module_id}</h3>
                        <div class="text-xs text-slate-600 mt-1">
                            Temp: <b>${sensor.self_temp}°F</b><br>
                            Dev: <b>${Number(sensor.deviation).toFixed(4)}</b>
                        </div>
                    </div>
                `);

                const marker = new maplibregl.Marker({ color: sensor.within_range ? '#34d399' : '#f87171' })
                    .setLngLat([sensor.long, sensor.lat])
                    .setPopup(popup)
                    .addTo(map);

                markers.push(marker);
                bounds.extend([sensor.long, sensor.lat]);
            });

            if (markers.length > 0) map.fitBounds(bounds, { padding: 50, maxZoom: 15 });

            if (tableBody) {
                tableBody.innerHTML = '';
                mergedData.forEach((sensor) => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-slate-50 transition-colors';
                    row.innerHTML = `
                        <td class="px-6 py-4 font-mono text-xs text-slate-500">${sensor.lat.toFixed(4)}, ${sensor.long.toFixed(4)}</td>
                        <td class="px-6 py-4 font-medium text-indigo-600">${sensor.self_temp}</td>
                        <td class="px-6 py-4 text-sky-600">${sensor.avg_neighbor_temp}</td>
                        <td class="px-6 py-4">
                            <span class="px-2 py-1 rounded-full text-xs ${sensor.within_range ? 'bg-emerald-100 text-emerald-700' : 'bg-red-100 text-red-700'}">
                                ${sensor.within_range ? 'Stable' : 'Outlier'}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-slate-400 text-xs">${Number(sensor.deviation).toFixed(5)}</td>
                    `;
                    tableBody.appendChild(row);
                });
            }

            updateCharts(mergedData);

        } catch (error) {
            console.error(error);
            if (errorEl) {
                errorEl.classList.remove('hidden');
                errorEl.textContent = `Error: ${error.message}`;
            }
        } finally {
            if (loadingEl) loadingEl.classList.add('hidden');
        }
    }

    const refreshBtn = document.getElementById('refresh-btn');
    if (refreshBtn) refreshBtn.addEventListener('click', fetchAndDisplayData);

    map.once('load', fetchAndDisplayData);
    setInterval(fetchAndDisplayData, 30000);
</script>
</body>
</html>