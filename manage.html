<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>HSN Module Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap');
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen text-slate-800">

<div id="app" class="max-w-4xl mx-auto px-4 py-8 space-y-8">
    <header class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
        <h1 class="text-2xl font-bold tracking-tight">Module <span class="text-indigo-600">Management</span></h1>
    </header>

    <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-6">
        <h2 class="text-xl font-semibold mb-4">Claim New Module</h2>
        <div class="flex space-x-4">
            <input type="text" id="claim-module-id" placeholder="Enter Module ID" class="flex-1 p-2 border border-slate-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
            <button id="claim-btn" class="px-4 py-2 bg-indigo-600 text-white font-medium rounded-lg hover:bg-indigo-700 transition-colors">Claim Module</button>
        </div>
        <p id="claim-message" class="mt-2 text-sm"></p>
    </div>

    <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
        <div class="px-6 py-4 border-b border-slate-50 bg-slate-50/50">
            <h2 class="font-semibold text-xl text-slate-800">Your Owned Modules</h2>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full text-left">
                <thead>
                <tr class="text-xs font-semibold text-slate-400 uppercase border-b border-slate-100">
                    <th class="px-6 py-3">ID</th>
                    <th class="px-6 py-3">Location (Lat, Long)</th>
                    <th class="px-6 py-3">Actions</th>
                </tr>
                </thead>
                <tbody id="modules-table-body" class="divide-y divide-slate-50 text-sm"></tbody>
            </table>
        </div>
    </div>
    <div id="error" class="bg-red-50 text-red-600 p-3 rounded-lg text-sm border border-red-100 hidden"></div>
</div>

<script>
    const API_ENDPOINT = 'https://hsn.eldonbaitandtackle.net/api/';
    const AUTH_TOKEN = 'your_retrieved_auth_token'; // Placeholder for the actual token

    async function apiCall(requestType, payload = {}) {
        const url = new URL(API_ENDPOINT);
        url.searchParams.append('request', requestType);
        for (const [key, value] of Object.entries(payload)) {
            url.searchParams.append(key, String(value));
        }
        const response = await fetch(url.toString());
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        return await response.json();
    }

    async function fetchAndDisplayModules() {
        const tableBody = document.getElementById('modules-table-body');
        const errorEl = document.getElementById('error');
        errorEl.classList.add('hidden');
        tableBody.innerHTML = '';

        try {
            const response = await apiCall('get_owned_modules', { token: AUTH_TOKEN });
            const modules = response.results || [];

            modules.forEach((module) => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-slate-50 transition-colors';
                const [lat, long] = module.location || [0, 0];
                const locationDisplay = `${lat.toFixed(4)}, ${long.toFixed(4)}`;

                row.innerHTML = `
                    <td class="px-6 py-4 font-mono text-xs text-slate-500">${module.id}</td>
                    <td class="px-6 py-4">
                        <input type="number" step="0.0001" id="lat-${module.id}" value="${lat.toFixed(4)}" class="w-20 p-1 border rounded text-xs">, 
                        <input type="number" step="0.0001" id="long-${module.id}" value="${long.toFixed(4)}" class="w-20 p-1 border rounded text-xs">
                    </td>
                    <td class="px-6 py-4">
                        <button onclick="updateLocation(${module.id})" class="px-3 py-1 bg-green-500 text-white text-xs rounded hover:bg-green-600">Update</button>
                        <span id="status-${module.id}" class="ml-2 text-xs"></span>
                    </td>
                `;
                tableBody.appendChild(row);
            });

        } catch (error) {
            console.error(error);
            errorEl.classList.remove('hidden');
            errorEl.textContent = `Error loading modules: ${error.message}`;
        }
    }

    async function updateLocation(moduleId) {
        const lat = parseFloat(document.getElementById(`lat-${moduleId}`).value);
        const long = parseFloat(document.getElementById(`long-${moduleId}`).value);
        const statusEl = document.getElementById(`status-${moduleId}`);
        statusEl.textContent = 'Updating...';
        statusEl.className = 'ml-2 text-xs text-blue-500';

        try {
            await apiCall('update_module_location', {
                token: AUTH_TOKEN,
                module_id: moduleId,
                lat: lat,
                long: long
            });
            statusEl.textContent = 'Success!';
            statusEl.className = 'ml-2 text-xs text-emerald-600';
        } catch (error) {
            console.error(error);
            statusEl.textContent = 'Failed!';
            statusEl.className = 'ml-2 text-xs text-red-600';
        } finally {
            // Clear status message after a short delay
            setTimeout(() => { statusEl.textContent = ''; statusEl.className = 'ml-2 text-xs'; }, 3000);
        }
    }

    document.getElementById('claim-btn').addEventListener('click', async () => {
        const moduleIdInput = document.getElementById('claim-module-id');
        const claimMessageEl = document.getElementById('claim-message');
        const moduleId = moduleIdInput.value.trim();

        if (!moduleId) {
            claimMessageEl.textContent = 'Please enter a Module ID.';
            claimMessageEl.className = 'mt-2 text-sm text-red-600';
            return;
        }

        claimMessageEl.textContent = 'Claiming...';
        claimMessageEl.className = 'mt-2 text-sm text-blue-600';

        try {
            await apiCall('claim_module', {
                token: AUTH_TOKEN,
                module_id: moduleId
            });
            claimMessageEl.textContent = `Module ${moduleId} claimed successfully!`;
            claimMessageEl.className = 'mt-2 text-sm text-emerald-600';
            moduleIdInput.value = '';
            fetchAndDisplayModules(); // Refresh list
        } catch (error) {
            console.error(error);
            claimMessageEl.textContent = `Claim failed for Module ${moduleId}: ${error.message}`;
            claimMessageEl.className = 'mt-2 text-sm text-red-600';
        }
    });

    window.onload = fetchAndDisplayModules;
</script>
</body>
</html>