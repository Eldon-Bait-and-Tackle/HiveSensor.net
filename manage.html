<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>HSN Module Management</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>

<div id="app" class="container">
    <header class="header">
        <div class="logo">
            <img src="hsn_logo.svg" alt="Hive Sensor Network Logo" class="img_logo"/>
            <h1 class="logo">Module Management</h1>
        </div>
    </header>

    <div class="card">
        <h2 class="card-title">Claim New Module</h2>
        <div style="display: flex; gap: 1rem;">
            <input type="text" id="claim-module-id" placeholder="Enter Device Secret" style="flex: 1; padding: 0.5rem; border: 1px solid var(--border); border-radius: 0.5rem;">
            <button id="claim-btn" class="btn-link" style="background: var(--primary); color: var(--bg-surface); padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 500;">Claim Module</button>
        </div>
        <p id="claim-message" style="margin-top: 0.5rem; font-size: 0.875rem;"></p>
    </div>

    <div class="card">
        <div class="table-header">
            <h2 class="card-title" style="margin: 0;">Your Owned Modules</h2>
        </div>
        <div class="table-wrapper">
            <table>
                <thead>
                <tr>
                    <th>ID</th>
                    <th>Location (Lat, Long)</th>
                    <th>Actions</th>
                </tr>
                </thead>
                <tbody id="modules-table-body"></tbody>
            </table>
        </div>
    </div>
    <div id="error" class="error-msg hidden" style="position: static; margin: 0;"></div>
</div>

<script>
    const API_ENDPOINT = 'https://hsn.eldonbaitandtackle.net/api/';
    const AUTH_TOKEN = 'your_retrieved_auth_token';

    async function apiCall(requestType, method = 'GET', payload = {}) {
        const url = new URL(API_ENDPOINT);
        url.searchParams.append('request', requestType);

        let body = null;
        if (method === 'GET' || method === 'OPTIONS') {
            for (const [key, value] of Object.entries(payload)) {
                url.searchParams.append(key, String(value));
            }
        } else if (method === 'POST') {
            body = JSON.stringify({...payload, auth_token: AUTH_TOKEN});
        }

        const response = await fetch(url.toString(), {
            method: method,
            headers: {
                'Content-Type': 'application/json'
            },
            body: body
        });
        if (!response.ok) {
            const errorData = await response.json().catch(() => ({ message: `HTTP ${response.status}` }));
            throw new Error(errorData.message || `HTTP ${response.status}`);
        }
        return await response.json();
    }

    async function fetchAndDisplayModules() {
        const tableBody = document.getElementById('modules-table-body');
        const errorEl = document.getElementById('error');
        errorEl.classList.add('hidden');
        tableBody.innerHTML = '';

        try {
            const response = await apiCall('get_owned_modules', 'GET', { auth_token: AUTH_TOKEN });
            const modules = response.modules || [];

            modules.forEach((module) => {
                const row = document.createElement('tr');
                const id = module.module_id || module.id;
                const [lat, long] = module.location || [0, 0];

                row.innerHTML = `
                    <td class="mono val-dim" style="font-size: 0.875rem; padding: 1rem 1.5rem;">${id}</td>
                    <td>
                        <input type="number" step="0.0001" id="lat-${id}" value="${lat.toFixed(4)}" style="width: 5rem; padding: 0.25rem; border: 1px solid var(--border); border-radius: 0.25rem; font-size: 0.75rem;">,
                        <input type="number" step="0.0001" id="long-${id}" value="${long.toFixed(4)}" style="width: 5rem; padding: 0.25rem; border: 1px solid var(--border); border-radius: 0.25rem; font-size: 0.75rem;">
                    </td>
                    <td>
                        <button onclick="updateLocation(${id})" class="btn-link" style="background: #10b981; color: white; padding: 0.25rem 0.75rem; border-radius: 0.25rem; font-size: 0.75rem;">Update</button>
                        <span id="status-${id}" class="val-dim" style="margin-left: 0.5rem;"></span>
                    </td>
                `;
                tableBody.appendChild(row);
            });

        } catch (error) {
            console.error(error);
            errorEl.classList.remove('hidden');
            errorEl.textContent = `Error loading modules: ${error.message}`;
        }
    }

    async function updateLocation(moduleId) {
        const lat = parseFloat(document.getElementById(`lat-${moduleId}`).value);
        const long = parseFloat(document.getElementById(`long-${moduleId}`).value);
        const statusEl = document.getElementById(`status-${moduleId}`);
        statusEl.textContent = 'Updating...';
        statusEl.className = 'val-secondary';

        try {
            await apiCall('update_location', 'POST', {
                module_id: moduleId,
                latitude: lat,
                longitude: long
            });
            statusEl.textContent = 'Success!';
            statusEl.className = 'status-pill stable';
        } catch (error) {
            console.error(error);
            statusEl.textContent = 'Failed!';
            statusEl.className = 'status-pill outlier';
        } finally {
            setTimeout(() => { statusEl.textContent = ''; statusEl.className = 'val-dim'; }, 3000);
        }
    }

    document.getElementById('claim-btn').addEventListener('click', async () => {
        const secretInput = document.getElementById('claim-module-id');
        const claimMessageEl = document.getElementById('claim-message');
        const secret = secretInput.value.trim();

        if (!secret) {
            claimMessageEl.textContent = 'Please enter the device secret.';
            claimMessageEl.style.color = 'var(--danger-text)';
            return;
        }

        claimMessageEl.textContent = 'Claiming...';
        claimMessageEl.style.color = 'var(--val-secondary)';

        try {
            const response = await apiCall('claim_device', 'POST', {
                secret: secret
            });
            const moduleId = response.module_id;

            claimMessageEl.textContent = `Module ${moduleId} claimed successfully!`;
            claimMessageEl.style.color = 'var(--success-text)';
            secretInput.value = '';
            fetchAndDisplayModules();
        } catch (error) {
            console.error(error);
            claimMessageEl.textContent = `Claim failed: ${error.message}`;
            claimMessageEl.style.color = 'var(--danger-text)';
        }
    });

    window.onload = fetchAndDisplayModules;
</script>
</body>
</html>