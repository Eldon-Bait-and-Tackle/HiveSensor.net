<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Module Manager</title>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        #status { margin-bottom: 20px; padding: 10px; border-radius: 4px; }
        .error { background-color: #f8d7da; color: #721c24; }
        .success { background-color: #d4edda; color: #155724; }
        button { padding: 10px 15px; cursor: pointer; }
        pre { background: #f4f4f4; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>

<h1>Module Management</h1>
<div id="status">Checking authentication...</div>
<div id="content" style="display:none;">
    <button onclick="logout()">Logout</button>
    <button onclick="loadModules()">Reload Modules</button>
    <h3>Modules Data:</h3>
    <pre id="dataOutput">Loading...</pre>
</div>

<script>
    const config = {
        authUrl: "https://auth.eldonbaitandtackle.net/realms/hsn_kc/protocol/openid-connect/auth",
        tokenUrl: "https://auth.eldonbaitandtackle.net/realms/hsn_kc/protocol/openid-connect/token",
        clientId: "public_client",
        realm: "hsn_kc",
        redirectUri: "https://hsw.eldonbaitandtackle.net/manage",
        apiUrl: "https://hsw.eldonbaitandtackle.net/manage"
    };

    async function init() {
        const params = new URLSearchParams(window.location.search);
        const code = params.get("code");
        const storedToken = sessionStorage.getItem("auth_token");

        if (code) {
            updateStatus("Exchanging code for token...", "success");
            await exchangeCode(code);
        } else if (storedToken) {
            showApp();
        } else {
            login();
        }
    }

    function login() {
        const url = `${config.authUrl}?client_id=${config.clientId}&response_type=code&redirect_uri=${encodeURIComponent(config.redirectUri)}&scope=openid`;
        window.location.href = url;
    }

    async function exchangeCode(code) {
        const body = new URLSearchParams({
            grant_type: "authorization_code",
            client_id: config.clientId,
            code: code,
            redirect_uri: config.redirectUri
        });

        try {
            const response = await fetch(config.tokenUrl, {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: body
            });

            const data = await response.json();

            if (data.access_token) {
                sessionStorage.setItem("auth_token", data.access_token);
                window.history.replaceState({}, document.title, window.location.pathname);
                showApp();
            } else {
                updateStatus("Login failed: " + JSON.stringify(data), "error");
            }
        } catch (e) {
            updateStatus("Network error during login.", "error");
        }
    }

    function showApp() {
        document.getElementById("content").style.display = "block";
        updateStatus("Authenticated", "success");
        loadModules();
    }

    async function loadModules() {
        const token = sessionStorage.getItem("auth_token");
        if (!token) return login();

        try {
            const response = await fetch(`${config.apiUrl}?request=get_module`, {
                method: "GET",
                headers: {
                    "Authorization": "Bearer " + token,
                    "Content-Type": "application/json"
                }
            });

            if (response.status === 401) {
                sessionStorage.removeItem("auth_token");
                return login();
            }

            const text = await response.text();
            try {
                const json = JSON.parse(text);
                document.getElementById("dataOutput").textContent = JSON.stringify(json, null, 2);
            } catch (e) {
                document.getElementById("dataOutput").textContent = text;
            }

        } catch (e) {
            document.getElementById("dataOutput").textContent = "Error fetching data: " + e.message;
        }
    }

    function logout() {
        sessionStorage.removeItem("auth_token");
        window.location.href = config.redirectUri;
    }

    function updateStatus(msg, type) {
        const el = document.getElementById("status");
        el.textContent = msg;
        el.className = type;
    }

    init();
</script>
</body>
</html>